// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum StudentStatus {
  ACTIVE
  INACTIVE
  GRADUATED
  TRANSFERRED
}

enum MaterialType {
  VIDEO
  DOCUMENT
  ASSIGNMENT
  QUIZ
  LINK
}

enum AssignmentStatus {
  PENDING
  SUBMITTED
  GRADED
  RETURNED
}

enum ExamType {
  QUIZ
  MIDTERM
  FINAL
  ASSIGNMENT
}

enum ExamStatus {
  DRAFT
  PUBLISHED
  ONGOING
  COMPLETED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
  FILL_BLANK
}

enum SubmissionStatus {
  IN_PROGRESS
  SUBMITTED
  GRADED
  EXPIRED
}

enum GradeType {
  ASSIGNMENT
  QUIZ
  MIDTERM
  FINAL
  PROJECT
  PARTICIPATION
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum InvoiceStatus {
  UNPAID
  PAID
  OVERDUE
  CANCELLED
}

enum MessageType {
  TEXT
  FILE
  IMAGE
  VOICE
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
}

// Core Tables
model School {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  code        String   @unique @db.VarChar(50)
  address     String?  @db.Text
  phone       String?  @db.VarChar(20)
  email       String?  @db.VarChar(255)
  logoUrl     String?  @map("logo_url") @db.VarChar(500)
  settings    Json?    // School-specific settings
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users      User[]
  classes    Class[]
  subjects   Subject[]
  students   Student[]
  teachers   User[]   @relation("TeacherSchool")
  invoices   Invoice[]
  exams      Exam[]
  lmsMaterials LMSMaterial[]
  
  // Club and Course Relations
  clubs      Club[]
  courses    Course[]

  @@map("schools")
}

model User {
  id          Int       @id @default(autoincrement())
  email       String    @unique @db.VarChar(255)
  password    String    @db.VarChar(255)
  fullName    String    @map("full_name") @db.VarChar(255)
  role        UserRole
  avatarUrl   String?   @map("avatar_url") @db.VarChar(500)
  phone       String?   @db.VarChar(20)
  address     String?   @db.Text
  dateOfBirth DateTime? @map("date_of_birth") @db.Date
  gender      Gender?
  schoolId    Int       @map("school_id")
  isActive    Boolean   @default(true) @map("is_active")
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  school              School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes             Class[] @relation("HomeroomTeacher")
  schedules           Schedule[]
  lmsMaterials        LMSMaterial[] @relation("PostedBy")
  assignments         Assignment[] @relation("AssignmentCreator")
  grades              Grade[] @relation("GradeCreator")
  attendanceSessions  AttendanceSession[]
  messagesSent        Message[] @relation("Sender")
  messagesReceived    Message[] @relation("Receiver")
  notifications       Notification[]
  aiAnalyses          AIAnalysis[]
  invoices            Invoice[] @relation("CreatedBy")
  parentStudents      Student[] @relation("ParentStudent")
  assignmentGraders   Assignment[] @relation("AssignmentGrader")
  gradeGraders        Grade[] @relation("GradeGrader")
  subjects            Subject[] @relation("SubjectTeacher")
  subjectTeachers     Subject[] @relation("TeacherSchool")
  exams               Exam[] @relation("ExamTeacher")
  attendanceRecords   AttendanceRecord[] @relation("AttendanceRecorder")
  aiRecommendations   AIRecommendation[]
  schoolTeachers      School[] @relation("TeacherSchool")
  
  // Club and Course Relations
  advisedClubs        Club[] @relation("ClubAdvisor")
  clubSchedules       ClubSchedule[] @relation("ClubScheduleTeacher")
  courseSchedules     CourseSchedule[] @relation("CourseScheduleTeacher")

  @@map("users")
}

model Class {
  id               Int    @id @default(autoincrement())
  schoolId         Int    @map("school_id")
  code             String @db.VarChar(50)
  name             String @db.VarChar(255)
  gradeLevel       Int    @map("grade_level")
  academicYear     String @map("academic_year") @db.VarChar(20)
  homeroomTeacherId Int?  @map("homeroom_teacher_id")
  room             String? @db.VarChar(50)
  maxStudents      Int    @default(50) @map("max_students")
  currentStudents  Int    @default(0) @map("current_students")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  school          School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  homeroomTeacher User?  @relation("HomeroomTeacher", fields: [homeroomTeacherId], references: [id])
  students        Student[]
  schedules       Schedule[]
  attendanceSessions AttendanceSession[]
  exams           Exam[] @relation("ExamClass")
  grades          Grade[] @relation("ClassGrades")

  @@unique([schoolId, code])
  @@map("classes")
}

model Student {
  id            Int          @id @default(autoincrement())
  schoolId      Int          @map("school_id")
  classId       Int?         @map("class_id")
  code          String       @unique @db.VarChar(50)
  fullName      String       @map("full_name") @db.VarChar(255)
  dateOfBirth   DateTime     @map("date_of_birth") @db.Date
  gender        Gender
  status        StudentStatus @default(ACTIVE)
  email         String?      @db.VarChar(255)
  phone         String?      @db.VarChar(20)
  address       String?      @db.Text
  parentId      Int?         @map("parent_id")
  avatarUrl     String?      @map("avatar_url") @db.VarChar(500)
  emergencyContact Json?     @map("emergency_contact")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  school              School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  class               Class? @relation(fields: [classId], references: [id], onDelete: SetNull)
  parent              User?  @relation("ParentStudent", fields: [parentId], references: [id])
  schedules           Schedule[] @relation("StudentSchedules")
  assignments         Assignment[]
  grades              Grade[] @relation("StudentGrades")
  attendanceRecords   AttendanceRecord[]
  invoices            Invoice[]
  studentSchedules    Schedule[] @relation("StudentSchedule")
  
  // Club and Course Relations
  clubMemberships     ClubMember[]
  courseEnrollments   CourseEnrollment[]
  
  // Exam Relations
  examSubmissions     ExamSubmission[] @relation("StudentExamSubmission")

  @@unique([schoolId, code])
  @@map("students")
}

model Subject {
  id          Int    @id @default(autoincrement())
  schoolId    Int    @map("school_id")
  code        String @db.VarChar(50)
  name        String @db.VarChar(255)
  description String? @db.Text
  credits     Int    @default(1)
  color       String? @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  school    School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schedules Schedule[]
  lmsMaterials LMSMaterial[]
  exams     Exam[] @relation("ExamSubject")
  grades    Grade[] @relation("SubjectGrades")
  teachers  User[] @relation("TeacherSchool")
  subjectTeachers User[] @relation("SubjectTeacher")

  @@unique([schoolId, code])
  @@map("subjects")
}

model Schedule {
  id          Int    @id @default(autoincrement())
  classId     Int    @map("class_id")
  subjectId   Int    @map("subject_id")
  teacherId   Int    @map("teacher_id")
  dayOfWeek   Int    @map("day_of_week") // 1-7 (Monday-Sunday)
  period      Int    // 1-8 (periods per day)
  room        String? @db.VarChar(50)
  semester    String @db.VarChar(20)
  academicYear String @map("academic_year") @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher User   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  students Student[] @relation("StudentSchedule")
  studentSchedules Student[] @relation("StudentSchedules")

  @@unique([classId, dayOfWeek, period])
  @@map("schedules")
}

// LMS Tables
model LMSMaterial {
  id          Int          @id @default(autoincrement())
  schoolId    Int          @map("school_id")
  subjectId   Int          @map("subject_id")
  title       String       @db.VarChar(255)
  description String?      @db.Text
  type        MaterialType
  fileUrl     String?      @map("file_url") @db.VarChar(500)
  thumbnailUrl String?     @map("thumbnail_url") @db.VarChar(500)
  postedBy    Int          @map("posted_by")
  deadline    DateTime?    @db.Date
  isPublished Boolean      @default(false) @map("is_published")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  school    School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  postedByUser User @relation("PostedBy", fields: [postedBy], references: [id])
  assignments Assignment[]

  @@map("lms_materials")
}

model Assignment {
  id           Int             @id @default(autoincrement())
  materialId   Int             @map("material_id")
  studentId    Int             @map("student_id")
  content      String?         @db.Text
  submissionUrl String?        @map("submission_url") @db.VarChar(500)
  score        Decimal?        @db.Decimal(5, 2)
  maxScore     Decimal         @default(100.0) @map("max_score") @db.Decimal(5, 2)
  feedback     String?         @db.Text
  status       AssignmentStatus @default(PENDING)
  submittedAt  DateTime?       @map("submitted_at")
  gradedAt     DateTime?       @map("graded_at")
  gradedBy     Int?            @map("graded_by")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  // Relations
  material LMSMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  student  Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  grader   User?   @relation("AssignmentGrader", fields: [gradedBy], references: [id])
  grades   Grade[] @relation("AssignmentGrades")
  createdBy User[] @relation("AssignmentCreator")

  @@unique([materialId, studentId])
  @@map("assignments")
}

// Assessment Tables

// Attendance Tables
model AttendanceSession {
  id        Int      @id @default(autoincrement())
  classId   Int      @map("class_id")
  date      DateTime @db.Date
  period    Int?     // Optional for full-day attendance
  teacherId Int      @map("teacher_id")
  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher User   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  records AttendanceRecord[]

  @@unique([classId, date, period])
  @@map("attendance_sessions")
}

model AttendanceRecord {
  id        Int              @id @default(autoincrement())
  sessionId Int              @map("session_id")
  studentId Int              @map("student_id")
  status    AttendanceStatus
  notes     String?          @db.Text
  recordedBy Int             @map("recorded_by")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  // Relations
  session AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  recorder User @relation("AttendanceRecorder", fields: [recordedBy], references: [id])

  @@unique([sessionId, studentId])
  @@map("attendance_records")
}

// Finance Tables
model Invoice {
  id          Int          @id @default(autoincrement())
  schoolId    Int          @map("school_id")
  studentId   Int          @map("student_id")
  title       String       @db.VarChar(255)
  description String?      @db.Text
  amount      Decimal      @db.Decimal(10, 2)
  dueDate     DateTime     @map("due_date") @db.Date
  status      InvoiceStatus @default(UNPAID)
  paymentMethod String?    @map("payment_method") @db.VarChar(50)
  transactionId String?    @map("transaction_id") @db.VarChar(100)
  paidAt      DateTime?    @map("paid_at")
  createdBy   Int          @map("created_by")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student  Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  creator  User   @relation("CreatedBy", fields: [createdBy], references: [id])

  @@map("invoices")
}

// Communication Tables
model Message {
  id             Int         @id @default(autoincrement())
  senderId       Int         @map("sender_id")
  receiverId     Int         @map("receiver_id")
  subject        String?     @db.VarChar(255)
  content        String      @db.Text
  type           MessageType @default(TEXT)
  attachmentUrl  String?     @map("attachment_url") @db.VarChar(500)
  isRead         Boolean     @default(false) @map("is_read")
  parentMessageId Int?       @map("parent_message_id")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  sender    User     @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver  User     @relation("Receiver", fields: [receiverId], references: [id], onDelete: Cascade)
  parent    Message? @relation("MessageReplies", fields: [parentMessageId], references: [id])
  replies   Message[] @relation("MessageReplies")

  @@map("messages")
}

model Notification {
  id        Int             @id @default(autoincrement())
  userId    Int             @map("user_id")
  title     String          @db.VarChar(255)
  message   String          @db.Text
  type      NotificationType
  data      Json?           // Additional notification data
  isRead    Boolean         @default(false) @map("is_read")
  createdAt DateTime        @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// AI Tables
model AIAnalysis {
  id              Int    @id @default(autoincrement())
  userId          Int    @map("user_id")
  analysisType    String @map("analysis_type") @db.VarChar(50) // STUDENT_RISK, PERFORMANCE, etc.
  inputData       Json   @map("input_data")
  resultData      Json   @map("result_data")
  confidenceScore Decimal? @map("confidence_score") @db.Decimal(3, 2)
  modelVersion    String @map("model_version") @db.VarChar(50)
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  recommendations AIRecommendation[]

  @@map("ai_analyses")
}

model AIRecommendation {
  id               Int    @id @default(autoincrement())
  userId           Int    @map("user_id")
  analysisId       Int    @map("analysis_id")
  recommendationType String @map("recommendation_type") @db.VarChar(50)
  content          String @db.Text
  priority         Int    @default(1)
  isImplemented    Boolean @default(false) @map("is_implemented")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  analysis AIAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@map("ai_recommendations")
}

// Additional Enums
enum ClubCategory {
  ACADEMIC
  SPORTS
  ARTS
  TECHNOLOGY
  COMMUNITY_SERVICE
  CULTURAL
  RECREATION
}

enum CourseType {
  REGULAR
  ELECTIVE
  ADVANCED
  REMEDIAL
  EXTRACURRICULAR
}

// Club and Course Models
model Club {
  id          Int          @id @default(autoincrement())
  schoolId    Int          @map("school_id")
  name        String       @db.VarChar(255)
  description String?      @db.Text
  category    ClubCategory
  advisorId   Int?         @map("advisor_id")
  maxMembers  Int          @default(50) @map("max_members")
  meetingRoom String?      @map("meeting_room") @db.VarChar(50)
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  advisor  User?  @relation("ClubAdvisor", fields: [advisorId], references: [id])
  members  ClubMember[]
  schedules ClubSchedule[]

  @@unique([schoolId, name])
  @@map("clubs")
}

model ClubMember {
  id       Int      @id @default(autoincrement())
  clubId   Int      @map("club_id")
  studentId Int     @map("student_id")
  joinedAt DateTime @default(now()) @map("joined_at")
  role     String   @default("MEMBER") @db.VarChar(50) // MEMBER, LEADER, TREASURER, etc.

  // Relations
  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([clubId, studentId])
  @@map("club_members")
}

model ClubSchedule {
  id        Int      @id @default(autoincrement())
  clubId    Int      @map("club_id")
  dayOfWeek Int      @map("day_of_week") // 1-7 (Monday-Sunday)
  startTime String   @map("start_time") @db.VarChar(5) // HH:MM format
  endTime   String   @map("end_time") @db.VarChar(5) // HH:MM format
  teacherId Int?     @map("teacher_id")
  room      String?  @db.VarChar(50)
  semester  String   @db.VarChar(20)
  academicYear String @map("academic_year") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  club    Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
  teacher User? @relation("ClubScheduleTeacher", fields: [teacherId], references: [id])

  @@unique([clubId, dayOfWeek, startTime])
  @@map("club_schedules")
}

model Course {
  id          Int        @id @default(autoincrement())
  schoolId    Int        @map("school_id")
  code        String     @db.VarChar(50)
  name        String     @db.VarChar(255)
  description String?    @db.Text
  type        CourseType @default(REGULAR)
  credits     Int        @default(1)
  maxStudents Int        @default(30) @map("max_students")
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  school    School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schedules CourseSchedule[]
  enrollments CourseEnrollment[]

  @@unique([schoolId, code])
  @@map("courses")
}

model CourseSchedule {
  id          Int    @id @default(autoincrement())
  courseId    Int    @map("course_id")
  teacherId   Int    @map("teacher_id")
  dayOfWeek   Int    @map("day_of_week") // 1-7 (Monday-Sunday)
  period      Int    // 1-8 (periods per day)
  room        String? @db.VarChar(50)
  semester    String @db.VarChar(20)
  academicYear String @map("academic_year") @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher User   @relation("CourseScheduleTeacher", fields: [teacherId], references: [id])

  @@unique([courseId, dayOfWeek, period])
  @@map("course_schedules")
}

model CourseEnrollment {
  id         Int      @id @default(autoincrement())
  courseId   Int      @map("course_id")
  studentId  Int      @map("student_id")
  enrolledAt DateTime @default(now()) @map("enrolled_at")
  status     String   @default("ACTIVE") @db.VarChar(20) // ACTIVE, DROPPED, COMPLETED

  // Relations
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([courseId, studentId])
  @@map("course_enrollments")
}

// Exam Models
model Exam {
  id           Int         @id @default(autoincrement())
  schoolId     Int         @map("school_id")
  classId      Int         @map("class_id")
  subjectId    Int         @map("subject_id")
  teacherId    Int         @map("teacher_id")
  title        String      @db.VarChar(255)
  description  String?     @db.Text
  type         ExamType    @default(QUIZ)
  status       ExamStatus  @default(DRAFT)
  duration     Int         // Duration in minutes
  maxAttempts  Int         @default(1)
  passingScore Int         @default(50) // Passing percentage
  startTime    DateTime    @map("start_time")
  endTime      DateTime    @map("end_time")
  totalQuestions Int       @default(0) @map("total_questions")
  maxScore     Decimal     @default(0) @map("max_score")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  // Relations
  school       School     @relation(fields: [schoolId], references: [id])
  class        Class      @relation("ExamClass", fields: [classId], references: [id])
  subject      Subject    @relation("ExamSubject", fields: [subjectId], references: [id])
  teacher      User       @relation("ExamTeacher", fields: [teacherId], references: [id])
  questions    Question[]
  submissions  ExamSubmission[]

  @@map("exams")
}

model Question {
  id          Int          @id @default(autoincrement())
  examId      Int          @map("exam_id")
  type        QuestionType
  content     String       @db.Text
  points      Int          @default(1)
  order       Int
  explanation String?      @db.Text
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  exam        Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  options     QuestionOption[]
  answers     SubmissionAnswer[]

  @@map("questions")
}

model QuestionOption {
  id         Int  @id @default(autoincrement())
  questionId Int  @map("question_id")
  content    String @db.Text
  isCorrect  Boolean @default(false) @map("is_correct")

  // Relations
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_options")
}

model ExamSubmission {
  id         Int              @id @default(autoincrement())
  examId     Int              @map("exam_id")
  studentId  Int              @map("student_id")
  startTime  DateTime         @map("start_time")
  endTime    DateTime?        @map("end_time")
  status     SubmissionStatus @default(IN_PROGRESS)
  score      Decimal?         @default(0)
  percentage Int?             @default(0)
  passed     Boolean?         @default(false)
  attempt    Int              @default(1)
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt @map("updated_at")

  // Relations
  exam        Exam             @relation(fields: [examId], references: [id])
  student     Student          @relation("StudentExamSubmission", fields: [studentId], references: [id])
  answers     SubmissionAnswer[]

  @@map("exam_submissions")
}

model SubmissionAnswer {
  id           Int    @id @default(autoincrement())
  submissionId Int    @map("submission_id")
  questionId   Int    @map("question_id")
  answer       String @db.Text // JSON string for complex answers
  isCorrect    Boolean? @default(false) @map("is_correct")
  points       Int? @default(0)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  submission   ExamSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  question     Question        @relation(fields: [questionId], references: [id])

  @@unique([submissionId, questionId])
  @@map("submission_answers")
}

// Grade Model
model Grade {
  id               Int       @id @default(autoincrement())
  studentId        Int       @map("student_id")
  subjectId        Int       @map("subject_id")
  classId          Int       @map("class_id")
  type             GradeType
  score            Decimal
  maxScore         Decimal   @map("max_score")
  percentage       Decimal
  letterGrade      String?   @map("letter_grade") @db.VarChar(5)
  gpa              Decimal?  @default(0)
  examScore        Decimal?  @map("exam_score")
  examMaxScore     Decimal?  @map("exam_max_score")
  examPercentage   Decimal? @map("exam_percentage")
  assignmentScore  Decimal?  @map("assignment_score")
  assignmentMaxScore Decimal? @map("assignment_max_score")
  assignmentPercentage Decimal? @map("assignment_percentage")
  participationScore Decimal? @map("participation_score")
  participationMaxScore Decimal? @map("participation_max_score")
  participationPercentage Decimal? @map("participation_percentage")
  semester         String    @db.VarChar(20)
  academicYear     String    @map("academic_year") @db.VarChar(20)
  comments         String?   @db.Text
  gradedBy         Int?      @map("graded_by")
  assignmentId     Int?      @map("assignment_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  student          Student   @relation("StudentGrades", fields: [studentId], references: [id])
  subject          Subject   @relation("SubjectGrades", fields: [subjectId], references: [id])
  class            Class     @relation("ClassGrades", fields: [classId], references: [id])
  createdBy        User[]    @relation("GradeCreator")
  grader           User?     @relation("GradeGrader", fields: [gradedBy], references: [id])
  assignment       Assignment? @relation("AssignmentGrades", fields: [assignmentId], references: [id])

  @@unique([studentId, subjectId, classId, semester, academicYear])
  @@map("grades")
}

// KTX Management Models
model KtxRoom {
  id                Int      @id @default(autoincrement())
  roomNumber        String   @unique @map("room_number") @db.VarChar(20)
  area              String   @map("area") @db.VarChar(10) // A, B
  floor             Int      @map("floor")
  capacity          Int      @map("capacity")
  currentOccupancy  Int      @default(0) @map("current_occupancy")
  type              String   @map("type") @db.VarChar(20) // Standard, Premium, VIP
  status            String   @default("Available") @map("status") @db.VarChar(20) // Available, Occupied, Maintenance, Cleaning, Reserved
  price             Int      @map("price") // Monthly rent
  electricityRate   Int      @default(3000) @map("electricity_rate") // Price per kWh
  waterRate         Int      @default(25000) @map("water_rate") // Price per m³
  facilities        Json?    @default("[]") @map("facilities") // Array of strings
  description       String?  @db.Text
  lastMaintenance   DateTime? @map("last_maintenance")
  nextMaintenance   DateTime? @map("next_maintenance")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  students          Student[]
  utilityBills      UtilityBill[]
  maintenanceRecords MaintenanceRecord[]

  @@map("ktx_rooms")
}

model UtilityBill {
  id              Int      @id @default(autoincrement())
  roomId          Int      @map("room_id")
  roomNumber      String   @map("room_number") @db.VarChar(20)
  month           String   @map("month") @db.VarChar(20)
  year            Int      @map("year")
  electricity     Int      @default(0) @map("electricity") // kWh
  water           Int      @default(0) @map("water") // m³
  electricityCost Int      @default(3000) @map("electricity_cost") // Price per kWh
  waterCost       Int      @default(25000) @map("water_cost") // Price per m³
  totalAmount     Int      @map("total_amount")
  status          String   @default("Unpaid") @map("status") @db.VarChar(20) // Paid, Unpaid, Overdue
  dueDate         DateTime @map("due_date")
  paidDate        DateTime? @map("paid_date")
  paymentMethod   String?  @map("payment_method") @db.VarChar(50)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  room            KtxRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  meterReadings   MeterReading[]

  @@unique([roomId, month, year])
  @@map("utility_bills")
}

model MeterReading {
  id           Int      @id @default(autoincrement())
  billId       Int      @map("bill_id")
  type         String   @map("type") @db.VarChar(20) // electricity, water
  previousReading Int?  @map("previous_reading")
  currentReading Int    @map("current_reading")
  usage        Int      @map("usage") // Current - Previous
  readingDate  DateTime @map("reading_date")
  notes        String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  bill         UtilityBill @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@map("meter_readings")
}

model MaintenanceRecord {
  id          Int      @id @default(autoincrement())
  roomId      Int      @map("room_id")
  type        String   @map("type") @db.VarChar(50) // cleaning, repair, inspection
  description String   @db.Text
  status      String   @default("Scheduled") @map("status") @db.VarChar(20) // Scheduled, In Progress, Completed
  scheduledDate DateTime @map("scheduled_date")
  completedDate DateTime? @map("completed_date")
  cost        Int?     @map("cost")
  performedBy String?  @map("performed_by") @db.VarChar(100)
  notes       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  room        KtxRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@map("maintenance_records")
}

// Hotel Management Models
model HotelRoom {
  id                Int      @id @default(autoincrement())
  roomNumber        String   @unique @map("room_number") @db.VarChar(20)
  floor             Int      @map("floor")
  type              String   @map("type") @db.VarChar(20) // Standard, Deluxe, Suite, Presidential
  status            String   @default("Available") @map("status") @db.VarChar(20) // Available, Occupied, Maintenance, Cleaning, Reserved
  capacity          Int      @map("capacity")
  pricePerNight     Int      @map("price_per_night")
  amenities         Json?    @default("[]") @map("amenities") // Array of strings
  description       String?  @db.Text
  lastCleaned       DateTime? @map("last_cleaned")
  nextCleaning      DateTime? @map("next_cleaning")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  bookings         Booking[]
  housekeeping     HousekeepingRecord[]

  @@map("hotel_rooms")
}

model Booking {
  id              Int      @id @default(autoincrement())
  roomId          Int      @map("room_id")
  guestName       String   @map("guest_name") @db.VarChar(255)
  guestEmail      String?  @map("guest_email") @db.VarChar(255)
  guestPhone      String   @map("guest_phone") @db.VarChar(20)
  checkInDate     DateTime @map("check_in_date")
  checkOutDate    DateTime @map("check_out_date")
  adults          Int      @default(1) @map("adults")
  children        Int      @default(0) @map("children")
  totalAmount     Int      @map("total_amount")
  status          String   @default("Confirmed") @map("status") @db.VarChar(20) // Confirmed, CheckedIn, CheckedOut, Cancelled
  specialRequests String?  @db.Text @map("special_requests")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  room            HotelRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@map("bookings")
}

model HousekeepingRecord {
  id            Int      @id @default(autoincrement())
  roomId        Int      @map("room_id")
  type          String   @map("type") @db.VarChar(50) // cleaning, maintenance, inspection
  status        String   @default("Scheduled") @map("status") @db.VarChar(20) // Scheduled, In Progress, Completed
  scheduledDate DateTime @map("scheduled_date")
  completedDate DateTime? @map("completed_date")
  staffName     String?  @map("staff_name") @db.VarChar(100)
  notes         String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  room          HotelRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@map("housekeeping_records")
}

